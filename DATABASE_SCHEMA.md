# üìä Documenta√ß√£o do Banco de Dados - Sistema KPI

## üìã Vis√£o Geral

Este documento descreve a estrutura completa do banco de dados do sistema KPI, incluindo todas as tabelas, relacionamentos, campos e constraints.

## üèóÔ∏è Arquitetura do Banco

### üîë Tabelas Principais
- **companies**: Empresas/Organiza√ß√µes
- **users**: Usu√°rios do sistema
- **customers**: Clientes
- **vehicles**: Ve√≠culos
- **leads**: Leads/Prospects

### üìä Tabelas de Neg√≥cio
- **sales**: Vendas
- **proposals**: Propostas
- **ads**: An√∫ncios
- **appointments**: Agendamentos
- **service_orders**: Ordens de servi√ßo

### üí∞ Tabelas Financeiras
- **accounts**: Contas financeiras
- **transactions**: Transa√ß√µes
- **reconciliations**: Concilia√ß√µes

### üìã Tabelas de Suporte
- **parts**: Pe√ßas
- **suppliers**: Fornecedores
- **settings**: Configura√ß√µes

---

## üìã Detalhamento das Tabelas

### üè¢ **companies**
Tabela principal que armazena informa√ß√µes das empresas/organiza√ß√µes.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `name` | VARCHAR | Nome da empresa | NOT NULL |
| `document` | VARCHAR | Documento (CNPJ) | UNIQUE |
| `email` | VARCHAR | E-mail da empresa | - |
| `phone` | VARCHAR | Telefone | - |
| `address` | TEXT | Endere√ßo completo | - |
| `city` | VARCHAR | Cidade | - |
| `state` | VARCHAR | Estado | - |
| `zip_code` | VARCHAR | CEP | - |
| `cnpj` | VARCHAR | CNPJ (campo adicional) | - |
| `primary_color` | VARCHAR(7) | Cor prim√°ria do sistema (HEX) | DEFAULT '#5CBEF5' |
| `secondary_color` | VARCHAR(7) | Cor secund√°ria do sistema (HEX) | DEFAULT '#0C1F2B' |
| `active` | BOOLEAN | Status ativo | DEFAULT true |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

### üë• **users**
Usu√°rios do sistema com acesso √† plataforma.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `email` | VARCHAR | E-mail do usu√°rio | NOT NULL, UNIQUE |
| `password` | VARCHAR | Senha criptografada | NOT NULL |
| `name` | VARCHAR | Nome completo | NOT NULL |
| `phone` | VARCHAR | Telefone | - |
| `position` | VARCHAR | Cargo/Fun√ß√£o | - |
| `department` | VARCHAR | Departamento | - |
| `company_id` | UUID | ID da empresa | FK ‚Üí companies(id) |
| `active` | BOOLEAN | Status ativo | DEFAULT true |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

### üë§ **customers**
Clientes da empresa.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `company_id` | UUID | ID da empresa | FK ‚Üí companies(id) |
| `name` | VARCHAR | Nome do cliente | NOT NULL |
| `email` | VARCHAR | E-mail | - |
| `phone` | VARCHAR | Telefone | - |
| `document` | VARCHAR | CPF/CNPJ | - |
| `address` | TEXT | Endere√ßo | - |
| `city` | VARCHAR | Cidade | - |
| `state` | VARCHAR | Estado | - |
| `zip_code` | VARCHAR | CEP | - |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

### üöó **vehicles**
Ve√≠culos dispon√≠veis para venda.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `company_id` | UUID | ID da empresa | FK ‚Üí companies(id) |
| `brand` | VARCHAR | Marca | NOT NULL |
| `model` | VARCHAR | Modelo | NOT NULL |
| `year` | INTEGER | Ano | NOT NULL |
| `color` | VARCHAR | Cor | - |
| `plate` | VARCHAR | Placa | - |
| `chassis` | VARCHAR | Chassi | - |
| `mileage` | INTEGER | Quilometragem | - |
| `price` | NUMERIC | Pre√ßo | - |
| `status` | VARCHAR | Status | DEFAULT 'available' |
| `description` | TEXT | Descri√ß√£o | - |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

### üéØ **leads**
Leads/Prospects interessados.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `company_id` | UUID | ID da empresa | FK ‚Üí companies(id) |
| `name` | VARCHAR | Nome do lead | NOT NULL |
| `email` | VARCHAR | E-mail | - |
| `phone` | VARCHAR | Telefone | - |
| `source` | VARCHAR | Origem do lead | - |
| `status` | VARCHAR | Status | DEFAULT 'new' |
| `notes` | TEXT | Observa√ß√µes | - |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

### üí∞ **sales**
Vendas realizadas.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `company_id` | UUID | ID da empresa | FK ‚Üí companies(id) |
| `customer_id` | UUID | ID do cliente | FK ‚Üí customers(id) |
| `vehicle_id` | UUID | ID do ve√≠culo | FK ‚Üí vehicles(id) |
| `user_id` | UUID | ID do vendedor | FK ‚Üí users(id) |
| `sale_price` | NUMERIC | Pre√ßo da venda | NOT NULL |
| `commission` | NUMERIC | Comiss√£o | - |
| `status` | VARCHAR | Status | DEFAULT 'pending' |
| `sale_date` | DATE | Data da venda | - |
| `notes` | TEXT | Observa√ß√µes | - |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

### üìã **proposals**
Propostas comerciais.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `company_id` | UUID | ID da empresa | FK ‚Üí companies(id) |
| `vehicle_id` | UUID | ID do ve√≠culo | FK ‚Üí vehicles(id) |
| `user_id` | UUID | ID do vendedor | FK ‚Üí users(id) |
| `customer_name` | TEXT | Nome do cliente | - |
| `vehicle_description` | TEXT | Descri√ß√£o do ve√≠culo | - |
| `vehicle_price` | NUMERIC | Pre√ßo do ve√≠culo | - |
| `down_payment` | NUMERIC | Valor da entrada | - |
| `financing_amount` | NUMERIC | Valor financiado | - |
| `installments` | INTEGER | N√∫mero de parcelas | - |
| `installment_value` | NUMERIC | Valor da parcela | - |
| `proposal_date` | DATE | Data da proposta | - |
| `status` | VARCHAR | Status | DEFAULT 'pending' |
| `notes` | TEXT | Observa√ß√µes | - |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

### üì¢ **ads**
An√∫ncios de ve√≠culos.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `company_id` | UUID | ID da empresa | FK ‚Üí companies(id) |
| `vehicle_id` | UUID | ID do ve√≠culo | FK ‚Üí vehicles(id) |
| `platform` | VARCHAR | Plataforma (OLX, Webmotors, etc.) | NOT NULL |
| `title` | VARCHAR | T√≠tulo do an√∫ncio | NOT NULL |
| `description` | TEXT | Descri√ß√£o | - |
| `price` | NUMERIC | Pre√ßo anunciado | - |
| `status` | VARCHAR | Status | DEFAULT 'active' |
| `published_at` | TIMESTAMP | Data de publica√ß√£o | - |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

### üìÖ **appointments**
Agendamentos de clientes.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `company_id` | UUID | ID da empresa | FK ‚Üí companies(id) |
| `customer_id` | UUID | ID do cliente | FK ‚Üí customers(id) |
| `vehicle_id` | UUID | ID do ve√≠culo | FK ‚Üí vehicles(id) |
| `title` | VARCHAR | T√≠tulo do agendamento | NOT NULL |
| `description` | TEXT | Descri√ß√£o | - |
| `appointment_date` | DATE | Data do agendamento | NOT NULL |
| `appointment_time` | TIME | Hor√°rio | NOT NULL |
| `duration` | INTEGER | Dura√ß√£o em minutos | DEFAULT 60 |
| `status` | VARCHAR | Status | DEFAULT 'scheduled' |
| `notes` | TEXT | Observa√ß√µes | - |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

### üìù **attendance_forms**
Formul√°rios de atendimento.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `company_id` | UUID | ID da empresa | FK ‚Üí companies(id) |
| `customer_name` | VARCHAR | Nome do cliente | NOT NULL |
| `email` | VARCHAR | E-mail | - |
| `phone` | VARCHAR | Telefone | - |
| `contact_method` | VARCHAR | M√©todo de contato | - |
| `attraction_media` | VARCHAR | M√≠dia de atra√ß√£o | - |
| `seller` | VARCHAR | Vendedor | - |
| `type` | VARCHAR | Tipo | - |
| `brand` | VARCHAR | Marca | - |
| `model` | VARCHAR | Modelo | - |
| `year` | INTEGER | Ano | - |
| `vehicle_type` | VARCHAR | Tipo de ve√≠culo | - |
| `price_range` | VARCHAR | Faixa de pre√ßo | - |
| `queue_brand` | VARCHAR | Marca na fila | - |
| `queue_model` | VARCHAR | Modelo na fila | - |
| `queue_version` | VARCHAR | Vers√£o na fila | - |
| `queue_color` | TEXT | Cor na fila | - |
| `queue_price_from` | TEXT | Pre√ßo m√≠nimo na fila | - |
| `queue_price_to` | TEXT | Pre√ßo m√°ximo na fila | - |
| `appointment_date` | DATE | Data do agendamento | - |
| `status` | VARCHAR | Status | DEFAULT 'pending' |
| `notes` | TEXT | Observa√ß√µes | - |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

### üõ†Ô∏è **service_orders**
Ordens de servi√ßo.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `company_id` | UUID | ID da empresa | FK ‚Üí companies(id) |
| `customer_id` | UUID | ID do cliente | FK ‚Üí customers(id) |
| `vehicle_id` | UUID | ID do ve√≠culo | FK ‚Üí vehicles(id) |
| `order_number` | VARCHAR | N√∫mero da ordem | NOT NULL |
| `description` | TEXT | Descri√ß√£o do servi√ßo | - |
| `status` | VARCHAR | Status | DEFAULT 'pending' |
| `total_amount` | NUMERIC | Valor total | - |
| `start_date` | DATE | Data de in√≠cio | - |
| `end_date` | DATE | Data de fim | - |
| `notes` | TEXT | Observa√ß√µes | - |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

### üí≥ **accounts**
Contas financeiras.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `company_id` | UUID | ID da empresa | FK ‚Üí companies(id) |
| `name` | VARCHAR | Nome da conta | NOT NULL |
| `type` | VARCHAR | Tipo da conta | NOT NULL |
| `category` | VARCHAR | Categoria | - |
| `description` | TEXT | Descri√ß√£o | - |
| `balance` | NUMERIC | Saldo atual | DEFAULT 0 |
| `active` | BOOLEAN | Status ativo | DEFAULT true |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

### üí∏ **transactions**
Transa√ß√µes financeiras.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `company_id` | UUID | ID da empresa | FK ‚Üí companies(id) |
| `account_id` | UUID | ID da conta | FK ‚Üí accounts(id) |
| `description` | VARCHAR | Descri√ß√£o | NOT NULL |
| `amount` | NUMERIC | Valor | NOT NULL |
| `type` | VARCHAR | Tipo (receita/despesa) | NOT NULL |
| `category` | VARCHAR | Categoria | - |
| `transaction_date` | DATE | Data da transa√ß√£o | NOT NULL |
| `notes` | TEXT | Observa√ß√µes | - |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

### üîÑ **reconciliations**
Concilia√ß√µes banc√°rias.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `company_id` | UUID | ID da empresa | FK ‚Üí companies(id) |
| `account_id` | UUID | ID da conta | FK ‚Üí accounts(id) |
| `statement_balance` | NUMERIC | Saldo do extrato | NOT NULL |
| `book_balance` | NUMERIC | Saldo cont√°bil | NOT NULL |
| `difference` | NUMERIC | Diferen√ßa | NOT NULL |
| `reconciliation_date` | DATE | Data da concilia√ß√£o | NOT NULL |
| `status` | VARCHAR | Status | DEFAULT 'pending' |
| `notes` | TEXT | Observa√ß√µes | - |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

### üîß **parts**
Pe√ßas e componentes.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `company_id` | UUID | ID da empresa | FK ‚Üí companies(id) |
| `supplier_id` | UUID | ID do fornecedor | FK ‚Üí suppliers(id) |
| `name` | VARCHAR | Nome da pe√ßa | NOT NULL |
| `part_number` | VARCHAR | N√∫mero da pe√ßa | - |
| `description` | TEXT | Descri√ß√£o | - |
| `category` | VARCHAR | Categoria | - |
| `unit_price` | NUMERIC | Pre√ßo unit√°rio | - |
| `stock_quantity` | INTEGER | Quantidade em estoque | DEFAULT 0 |
| `min_stock` | INTEGER | Estoque m√≠nimo | DEFAULT 0 |
| `active` | BOOLEAN | Status ativo | DEFAULT true |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

### üè≠ **suppliers**
Fornecedores.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `company_id` | UUID | ID da empresa | FK ‚Üí companies(id) |
| `name` | VARCHAR | Nome do fornecedor | NOT NULL |
| `email` | VARCHAR | E-mail | - |
| `phone` | VARCHAR | Telefone | - |
| `document` | VARCHAR | CNPJ | - |
| `address` | TEXT | Endere√ßo | - |
| `city` | VARCHAR | Cidade | - |
| `state` | VARCHAR | Estado | - |
| `zip_code` | VARCHAR | CEP | - |
| `contact_person` | VARCHAR | Pessoa de contato | - |
| `active` | BOOLEAN | Status ativo | DEFAULT true |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

### ‚öôÔ∏è **settings**
Configura√ß√µes do sistema.

| Campo | Tipo | Descri√ß√£o | Constraints |
|-------|------|-----------|-------------|
| `id` | UUID | Identificador √∫nico | PK, DEFAULT gen_random_uuid() |
| `company_id` | UUID | ID da empresa | FK ‚Üí companies(id) |
| `key` | VARCHAR | Chave da configura√ß√£o | NOT NULL |
| `value` | TEXT | Valor | - |
| `description` | TEXT | Descri√ß√£o | - |
| `created_at` | TIMESTAMP | Data de cria√ß√£o | DEFAULT now() |
| `updated_at` | TIMESTAMP | Data de atualiza√ß√£o | DEFAULT now() |

---

## üîó Relacionamentos Principais

### üè¢ **companies** (Tabela Central)
- **1:N** ‚Üí users, customers, vehicles, leads, sales, proposals, ads, appointments, etc.
- Todas as tabelas principais referenciam `companies.id`

### üë• **users**
- **N:1** ‚Üí companies
- **1:N** ‚Üí sales, proposals (como vendedor)

### üë§ **customers**
- **N:1** ‚Üí companies
- **1:N** ‚Üí sales, appointments, service_orders

### üöó **vehicles**
- **N:1** ‚Üí companies
- **1:N** ‚Üí sales, proposals, ads, appointments, service_orders

### üí∞ **sales**
- **N:1** ‚Üí companies, customers, vehicles, users
- Tabela de jun√ß√£o para vendas

### üìã **proposals**
- **N:1** ‚Üí companies, vehicles, users
- Propostas comerciais

---

## üìä Tabelas de Apoio

### üìé **appointment_attachments**
Anexos dos formul√°rios de atendimento.

### üìû **contact_history**
Hist√≥rico de contatos.

### üìã **formalization_*** (4 tabelas)
- **formalization_clients**: Dados dos clientes na formaliza√ß√£o
- **formalization_deliveries**: Dados de entrega
- **formalization_payments**: Dados de pagamento
- **formalization_types**: Tipos de formaliza√ß√£o

### üë• **legal_owners** / **possession_owners**
Propriet√°rios legais e de posse.

### üîç **vehicle_evaluations**
Avalia√ß√µes de ve√≠culos.

### üîß **repair_estimates**
Or√ßamentos de reparo.

### üîç **vehicles_search**
Tabela de busca de ve√≠culos.

---

## üéØ Padr√µes de Nomenclatura

### üìù **Conven√ß√µes**
- **IDs**: UUID com `gen_random_uuid()`
- **Timestamps**: `created_at`, `updated_at` com `DEFAULT now()`
- **Status**: Campos VARCHAR com valores padr√£o
- **Foreign Keys**: `{tabela}_id` (ex: `company_id`, `user_id`)
- **Booleanos**: `active`, `enabled` com `DEFAULT true`

### üîë **Chaves Prim√°rias**
- Todas as tabelas usam UUID como PK
- Exce√ß√£o: Tabelas de apoio usam INTEGER com `nextval()`

### üîó **Foreign Keys**
- Todas referenciam `companies.id` para isolamento multi-tenant
- Relacionamentos bem definidos entre entidades

---

## üöÄ Considera√ß√µes de Performance

### üìà **√çndices Recomendados**
```sql
-- √çndices para consultas frequentes
CREATE INDEX idx_sales_company_date ON sales(company_id, sale_date);
CREATE INDEX idx_customers_company_name ON customers(company_id, name);
CREATE INDEX idx_vehicles_company_status ON vehicles(company_id, status);
CREATE INDEX idx_leads_company_status ON leads(company_id, status);
CREATE INDEX idx_proposals_company_status ON proposals(company_id, status);
```

### üîç **Consultas Otimizadas**
- Sempre filtrar por `company_id` para multi-tenancy
- Usar `created_at` para ordena√ß√£o temporal
- √çndices compostos para consultas complexas

---

## üìã Status e Valores Padr√£o

### üìä **Status Comuns**
- **sales.status**: 'pending', 'completed', 'cancelled'
- **proposals.status**: 'pending', 'accepted', 'rejected'
- **ads.status**: 'active', 'paused', 'sold'
- **appointments.status**: 'scheduled', 'completed', 'cancelled'
- **leads.status**: 'new', 'contacted', 'qualified', 'lost'

### üîÑ **Valores Padr√£o**
- **active**: `DEFAULT true`
- **created_at**: `DEFAULT now()`
- **updated_at**: `DEFAULT now()`
- **balance**: `DEFAULT 0`
- **stock_quantity**: `DEFAULT 0`

---

## üõ°Ô∏è Seguran√ßa e RLS

### üîí **Row Level Security (RLS)**
- Todas as tabelas devem ter RLS habilitado
- Pol√≠ticas baseadas em `company_id`
- Isolamento completo entre empresas

### üîê **Pol√≠ticas Recomendadas**
```sql
-- Exemplo de pol√≠tica RLS
CREATE POLICY "Users can only see their company data" 
ON sales FOR ALL 
TO authenticated 
USING (company_id = auth.jwt() ->> 'company_id');
```

---

## üìù Notas de Implementa√ß√£o

### ‚ö†Ô∏è **Aten√ß√µes**
1. **Multi-tenancy**: Sempre filtrar por `company_id`
2. **UUIDs**: Usar `gen_random_uuid()` para novos registros
3. **Timestamps**: Manter `created_at` e `updated_at` atualizados
4. **Constraints**: Respeitar foreign keys e constraints
5. **RLS**: Implementar pol√≠ticas de seguran√ßa adequadas

### üîß **Manuten√ß√£o**
- Backup regular das tabelas principais
- Monitoramento de performance dos √≠ndices
- Limpeza peri√≥dica de dados antigos
- Atualiza√ß√£o de estat√≠sticas do banco

---

## üîÑ **Versionamento e Manuten√ß√£o do Schema**

### üìã **REGRA CR√çTICA - Atualiza√ß√µes do Banco**

> **SEMPRE que houver altera√ß√£o em qualquer tabela do banco de dados, a documenta√ß√£o DEVE ser atualizada e o SQL ALTER TABLE DEVE ser fornecido**

### üéØ **Processo Obrigat√≥rio**

#### 1Ô∏è‚É£ **Quando Alterar uma Tabela**
- ‚úÖ Adicionar nova coluna
- ‚úÖ Remover coluna existente
- ‚úÖ Modificar tipo de dados
- ‚úÖ Adicionar/remover constraints
- ‚úÖ Criar/remover √≠ndices
- ‚úÖ Alterar valores padr√£o
- ‚úÖ Modificar foreign keys

#### 2Ô∏è‚É£ **A√ß√µes Obrigat√≥rias**
1. **üìù Atualizar Documenta√ß√£o**: Modificar `DATABASE_SCHEMA.md`
2. **üîß Gerar SQL**: Criar script `ALTER TABLE` correspondente
3. **üì§ Entregar SQL**: Fornecer o script para execu√ß√£o
4. **üìã Documentar Mudan√ßa**: Registrar a altera√ß√£o

### üìù **Template de Atualiza√ß√£o**

```markdown
## üîÑ **√öltimas Altera√ß√µes**

### üìÖ **Data: [DD/MM/AAAA]**
- **Tabela**: `[nome_da_tabela]`
- **Altera√ß√£o**: `[descri√ß√£o_da_mudan√ßa]`
- **Arquivo SQL**: `[nome_do_arquivo].sql`
- **Status**: `[Pendente/Executado]`
```

### üîß **Exemplos de ALTER TABLE**

#### ‚ûï **Adicionar Coluna**
```sql
-- Exemplo: Adicionar campo 'priority' na tabela leads
ALTER TABLE public.leads 
ADD COLUMN priority VARCHAR DEFAULT 'normal';

COMMENT ON COLUMN public.leads.priority IS 'Prioridade do lead (low, normal, high, urgent)';
```

#### ‚ûñ **Remover Coluna**
```sql
-- Exemplo: Remover campo 'old_field' da tabela customers
ALTER TABLE public.customers 
DROP COLUMN IF EXISTS old_field;
```

#### üîÑ **Modificar Coluna**
```sql
-- Exemplo: Alterar tipo de dados e adicionar constraint
ALTER TABLE public.vehicles 
ALTER COLUMN year TYPE INTEGER,
ALTER COLUMN year SET NOT NULL;
```

#### üîó **Adicionar Foreign Key**
```sql
-- Exemplo: Adicionar FK para category_id
ALTER TABLE public.parts 
ADD COLUMN category_id UUID,
ADD CONSTRAINT fk_parts_category 
FOREIGN KEY (category_id) REFERENCES public.categories(id);
```

#### üìä **Adicionar √çndice**
```sql
-- Exemplo: Criar √≠ndice para performance
CREATE INDEX IF NOT EXISTS idx_sales_company_date_status 
ON public.sales(company_id, sale_date, status);
```

### üìã **Checklist de Atualiza√ß√£o**

#### ‚úÖ **Antes da Altera√ß√£o**
- [ ] Documentar a necessidade da mudan√ßa
- [ ] Verificar impacto em outras tabelas
- [ ] Testar em ambiente de desenvolvimento
- [ ] Gerar script SQL de rollback

#### ‚úÖ **Durante a Altera√ß√£o**
- [ ] Executar script em ambiente de teste
- [ ] Validar dados ap√≥s altera√ß√£o
- [ ] Verificar performance
- [ ] Testar funcionalidades afetadas

#### ‚úÖ **Ap√≥s a Altera√ß√£o**
- [ ] Atualizar `DATABASE_SCHEMA.md`
- [ ] Documentar a mudan√ßa
- [ ] Notificar equipe de desenvolvimento
- [ ] Atualizar testes automatizados

### üóÇÔ∏è **Estrutura de Arquivos SQL**

```
/sql/
‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îú‚îÄ‚îÄ 2025-01-15_add_priority_to_leads.sql
‚îÇ   ‚îú‚îÄ‚îÄ 2025-01-16_remove_old_field_from_customers.sql
‚îÇ   ‚îî‚îÄ‚îÄ 2025-01-17_add_index_to_sales.sql
‚îú‚îÄ‚îÄ rollbacks/
‚îÇ   ‚îú‚îÄ‚îÄ 2025-01-15_rollback_priority_from_leads.sql
‚îÇ   ‚îî‚îÄ‚îÄ 2025-01-16_rollback_remove_old_field.sql
‚îî‚îÄ‚îÄ documentation/
    ‚îî‚îÄ‚îÄ DATABASE_SCHEMA.md
```

### üìù **Formato dos Scripts SQL**

#### üîß **Script de Migra√ß√£o**
```sql
-- =============================================
-- Migration: [Descri√ß√£o da altera√ß√£o]
-- Date: [DD/MM/AAAA]
-- Author: [Nome do desenvolvedor]
-- Description: [Descri√ß√£o detalhada]
-- =============================================

-- Backup recomendado
-- CREATE TABLE [tabela]_backup_[data] AS SELECT * FROM [tabela];

-- Altera√ß√£o principal
ALTER TABLE public.[tabela] 
[comando_alteracao];

-- Coment√°rios
COMMENT ON COLUMN public.[tabela].[coluna] IS '[Descri√ß√£o]';

-- √çndices (se necess√°rio)
CREATE INDEX IF NOT EXISTS idx_[tabela]_[coluna] 
ON public.[tabela]([coluna]);

-- Valida√ß√£o
SELECT COUNT(*) FROM public.[tabela] WHERE [condicao_validacao];
```

#### üîÑ **Script de Rollback**
```sql
-- =============================================
-- Rollback: [Descri√ß√£o da revers√£o]
-- Date: [DD/MM/AAAA]
-- Author: [Nome do desenvolvedor]
-- Description: [Descri√ß√£o da revers√£o]
-- =============================================

-- Reverter altera√ß√£o
ALTER TABLE public.[tabela] 
[comando_reversao];

-- Remover √≠ndices (se necess√°rio)
DROP INDEX IF EXISTS idx_[tabela]_[coluna];

-- Valida√ß√£o
SELECT COUNT(*) FROM public.[tabela] WHERE [condicao_validacao];
```

### üö® **Regras de Seguran√ßa**

#### ‚ö†Ô∏è **Nunca Fazer**
- ‚ùå Alterar tabelas em produ√ß√£o sem backup
- ‚ùå Remover colunas sem verificar depend√™ncias
- ‚ùå Modificar tipos de dados sem valida√ß√£o
- ‚ùå Executar scripts sem testar primeiro

#### ‚úÖ **Sempre Fazer**
- ‚úÖ Backup antes de qualquer altera√ß√£o
- ‚úÖ Testar em ambiente de desenvolvimento
- ‚úÖ Documentar todas as mudan√ßas
- ‚úÖ Gerar script de rollback
- ‚úÖ Validar dados ap√≥s altera√ß√£o

### üìä **Controle de Vers√£o**

#### üî¢ **Versionamento do Schema**
- **Vers√£o Atual**: `1.0.0`
- **Formato**: `MAJOR.MINOR.PATCH`
- **MAJOR**: Mudan√ßas que quebram compatibilidade
- **MINOR**: Novas funcionalidades compat√≠veis
- **PATCH**: Corre√ß√µes e pequenos ajustes

#### üìÖ **Hist√≥rico de Altera√ß√µes**

```markdown
## üìÖ **Hist√≥rico de Vers√µes**

### üî¢ **v1.0.0** - 15/01/2025
- ‚úÖ Schema inicial do banco de dados
- ‚úÖ 25 tabelas principais criadas
- ‚úÖ Relacionamentos e constraints definidos
- ‚úÖ RLS e pol√≠ticas de seguran√ßa implementadas

### üî¢ **v1.1.0** - [Pr√≥xima vers√£o]
- üîÑ [Altera√ß√µes planejadas]
```

### üìã **Responsabilidades**

#### üë®‚Äçüíª **Desenvolvedor**
- [ ] Identificar necessidade de altera√ß√£o
- [ ] Criar script SQL de altera√ß√£o
- [ ] Testar em ambiente de desenvolvimento
- [ ] Atualizar documenta√ß√£o
- [ ] Solicitar execu√ß√£o em produ√ß√£o

#### üóÑÔ∏è **DBA/Administrador**
- [ ] Revisar script SQL
- [ ] Executar backup antes da altera√ß√£o
- [ ] Executar script em produ√ß√£o
- [ ] Validar integridade dos dados
- [ ] Monitorar performance p√≥s-altera√ß√£o

#### üìù **Documentador**
- [ ] Atualizar `DATABASE_SCHEMA.md`
- [ ] Registrar altera√ß√£o no hist√≥rico
- [ ] Atualizar diagramas (se necess√°rio)
- [ ] Comunicar mudan√ßas √† equipe

---

## üîÑ **√öltimas Altera√ß√µes**

### üìÖ **Data: 15/01/2025**
- **Tabela**: `companies`
- **Altera√ß√£o**: `Adicionar campos de personaliza√ß√£o de cores (primary_color, secondary_color)`
- **Arquivo SQL**: `2025-01-15_add_color_fields_to_companies.sql`
- **Status**: `Pendente`
- **Detalhes**: 
  - Adicionado campo `primary_color VARCHAR(7) DEFAULT '#5CBEF5'`
  - Adicionado campo `secondary_color VARCHAR(7) DEFAULT '#0C1F2B'`
  - Permite personaliza√ß√£o visual por empresa
  - Valores padr√£o em formato HEX
  - Coment√°rios adicionados para documenta√ß√£o
  - Script de rollback dispon√≠vel

### üìÖ **Data: 15/01/2025**
- **Tabela**: `sales, transactions, service_orders, parts, proposals`
- **Altera√ß√£o**: `DRE 100% com dados reais do banco - remo√ß√£o completa de dados mock`
- **Arquivo SQL**: `N/A (Apenas consultas)`
- **Status**: `Conclu√≠do`
- **Detalhes**: 
  - DRE agora busca dados reais de 5 tabelas: `sales`, `transactions`, `service_orders`, `parts`, `proposals`
  - Receitas: Vendas de ve√≠culos, pe√ßas, servi√ßos, propostas aceitas, comiss√µes, outras receitas
  - Despesas: Transa√ß√µes de despesa + custo das pe√ßas (calculado)
  - C√°lculos autom√°ticos de receitas, despesas e margens baseados em dados reais
  - Filtros por per√≠odo e empresa (multi-tenancy)
  - Remo√ß√£o completa de dados mock - apenas dados reais do banco
  - Tratamento robusto de erros sem fallback para mock

### üìÖ **Data: 15/01/2025**
- **Tabela**: `Nenhuma`
- **Altera√ß√£o**: `Cria√ß√£o da documenta√ß√£o inicial do banco de dados`
- **Arquivo SQL**: `N/A`
- **Status**: `Conclu√≠do`

---

*Documenta√ß√£o gerada automaticamente baseada no schema do banco de dados.*
*√öltima atualiza√ß√£o: Janeiro 2025*
*Vers√£o do Schema: 1.0.0*
